<script>
document.addEventListener('DOMContentLoaded', function () {
  var AppUI = window.AppUI;
  if (!AppUI) return;
  var $ = AppUI.$;

  var rows        = $('rows');
  if (!rows) return;

  var pageInfo    = $('pageInfo');
  var prevBtn     = $('prevBtn');
  var nextBtn     = $('nextBtn');
  var form        = $('filtersForm');
  var whatEverInp = $('whatEverText');
  var fromInp     = $('from');
  var toInp       = $('to');
  var categoryInp = $('categoryInputSearch');
  var clearBtn    = $('clearBtn');

  var state = {
    page: 1,
    total: 0,
    totalPages: 0,
    filters: { whatEverText: '', from: '', to: '', category: '' }
  };

  function updatePager() {
    if (!pageInfo) return;
    pageInfo.textContent = (state.totalPages > 0)
      ? 'Página ' + state.page + ' de ' + state.totalPages + ' · ' + state.total + ' registros'
      : '—';
    if (prevBtn) prevBtn.disabled = state.page <= 1;
    if (nextBtn) nextBtn.disabled = state.page >= state.totalPages;
  }

  function render(items) {
    rows.innerHTML = '';
    if (!items || !items.length) {
      rows.innerHTML = '<tr><td colspan="7" class="text-muted">Sin resultados.</td></tr>';
      return;
    }

    items.forEach(function (it) {
      var fullComment    = it.comments || '';
      var displayComment = fullComment;
      if (displayComment.length > 30) {
        displayComment = displayComment.slice(0, 30) + '…';
      }

      var payload = JSON.stringify(it)
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      var tr = document.createElement('tr');
      tr.innerHTML = ''
        + '<td>' + (it.expenseDate || '') + '</td>'
        + '<td>' + (it.amount ?? '') + '</td>'
        + '<td>' + (it.category ?? '') + '</td>'
        + '<td class="text-truncate" title="' + fullComment.replace(/"/g, '&quot;') + '">' + displayComment + '</td>'
        + '<td>' + (it.source ?? '') + '</td>'
        + '<td class="text-end">'
        + '  <button type="button"'
        + '          class="btn btn-sm btn-brand"'
        + '          data-edit="' + payload + '"'
        + '          title="Editar">'
        + '    <i class="fa-solid fa-pen-to-square"></i>'
        + '  </button>'
        + '</td>';

      rows.appendChild(tr);
    });
  }

  function fetchData() {
    AppUI.showLoader(true);
    google.script.run
      .withSuccessHandler(function (res) {
        AppUI.showLoader(false);
        if (!res) {
          render([]);
          state.total      = 0;
          state.totalPages = 0;
          updatePager();
          return;
        }
        state.total      = res.total || 0;
        state.totalPages = res.totalPages || 0;
        render(res.items || []);
        updatePager();
      })
      .withFailureHandler(function (err) {
        AppUI.showLoader(false);
        var msg = (err && err.message) ? err.message : 'No se pudo obtener los datos';
        AppUI.toast(msg, false);
      })
      .findExpensesByFilters({
        whatEverText: state.filters.whatEverText,
        from:         state.filters.from,
        to:           state.filters.to,
        category:     state.filters.category,
        page:         state.page
      });
  }

  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      state.page = 1;
      state.filters = {
        whatEverText: whatEverInp.value.trim(),
        from:         fromInp.value || '',
        to:           toInp.value || '',
        category:     categoryInp.value.trim()
      };
      fetchData();
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', function () {
      whatEverInp.value = '';
      fromInp.value     = '';
      toInp.value       = '';
      categoryInp.value = '';
      state.page        = 1;
      state.filters     = { whatEverText: '', from: '', to: '', category: '' };
      fetchData();
    });
  }

  if (prevBtn) {
    prevBtn.addEventListener('click', function () {
      if (state.page > 1) {
        state.page--;
        fetchData();
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', function () {
      if (state.page < state.totalPages) {
        state.page++;
        fetchData();
      }
    });
  }

  rows.addEventListener('click', function (e) {
    var btn = e.target.closest('[data-edit]');
    if (!btn) return;
    var raw = btn.getAttribute('data-edit');
    try {
      var item = JSON.parse(
        raw.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
      );
      if (window.__setUpdateDataFromSearch) {
        window.__setUpdateDataFromSearch(item);
      }
    } catch (err) {
      AppUI.toast('No se pudo abrir el registro para edición.', false);
    }
  });

  window.__refreshSearch = function () {
    fetchData();
  };

  // First load
  fetchData();
});
</script>
